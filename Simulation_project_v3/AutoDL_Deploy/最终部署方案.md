# AutoDL校准任务最终部署方案

## 核心修改说明

本次为实现并行校准，对项目进行了以下核心修改：

### 1. 优化算法层面并行（核心）

**文件：`CONFIG/calibration_config.yaml`**
- 修改优化算法：`Nelder-Mead` → `differential_evolution`
- 并行设置：
  - `popsize: 32` - 每代评估32个参数组合
  - `workers: 32` - 使用32个进程并行
  - 理论加速：32倍

**文件：`MODULES/CALIBRATION/smm_calibrator.py`**
- 添加 `differential_evolution` 算法支持
- 自动识别并行/串行优化算法

**文件：`TESTS/test_calibration.py`**
- 添加Numba环境变量配置（辅助优化）
- 设置 `NUMBA_NUM_THREADS=128`
- 设置 `NUMBA_THREADING_LAYER=omp`

### 2. 并行原理

```
原方案（不work）：
├── Nelder-Mead（串行）
├── 每次评估1个参数点
├── 单个MFG求解用Numba并行
└── 大部分核心空闲 ❌

新方案（应该work）：
├── Differential Evolution（并行）
├── 每代同时评估32个参数点
├── 32个进程各自独立运行MFG求解
└── 充分利用128核心 ✅
```

## 部署步骤

### 步骤1：上传修改后的文件

使用WinSCP上传以下3个核心文件到AutoDL服务器：

```
本地 → 服务器
├── TESTS/test_calibration.py → ~/Simulation_project_v3/TESTS/
├── CONFIG/calibration_config.yaml → ~/Simulation_project_v3/CONFIG/
└── MODULES/CALIBRATION/smm_calibrator.py → ~/Simulation_project_v3/MODULES/CALIBRATION/
```

### 步骤2：SSH连接并运行

```bash
# SSH连接到AutoDL
ssh -p 端口 root@地址

# 运行校准
cd ~/Simulation_project_v3
bash AutoDL_Deploy/force_parallel_run.sh
```

### 步骤3：监控运行

**查看CPU使用率：**
```bash
htop
```
预期：看到**多个python进程**同时运行，Load average: 50-100

**查看日志：**
```bash
tail -f OUTPUT/calibration/calibration_run.log
```

**进入screen会话：**
```bash
screen -r calibration
# 退出：Ctrl+A 然后按 D
```

## 预期效果

### 性能对比

| 方案 | 算法 | 并行方式 | 预计时间 |
|------|------|----------|----------|
| 原方案 | Nelder-Mead | 串行 | ~7天 |
| 新方案 | Differential Evolution | 32进程并行 | **~0.5-1天** |

### 运行状态

**正常状态：**
- ✅ htop中看到30+个python进程
- ✅ Load average: 50-100
- ✅ 大量CPU核心显示高使用率

**异常状态：**
- ❌ 只有1-2个python进程
- ❌ Load average < 10
- ❌ 大部分CPU核心空闲

## 文件结构

```
AutoDL_Deploy/
├── force_parallel_run.sh          # 核心运行脚本
├── autodl_setup.sh                # 环境设置
├── quick_test.sh                  # 快速测试
├── monitor_script.sh              # 监控脚本
├── email_notify.sh                # 通知脚本
├── upload_to_autodl.ps1           # 上传脚本（Windows）
├── AUTODL使用教程.md              # 详细教程
├── AutoDL快速开始.txt             # 快速参考
├── README_AUTODL.md               # AutoDL总体说明
├── 监控指南.md                    # 监控详细指南
├── 关于关机后监控-简明版.txt      # 监控简明版
├── 并行优化方案.txt               # 并行方案说明
└── 最终部署方案.md                # 本文件
```

## 故障排查

### 问题1：还是只有单进程运行

**检查：**
```bash
ps aux | grep python | wc -l
```
如果只返回1-2个，说明并行没有启动。

**解决：**
1. 确认上传了最新的 `calibration_config.yaml`
2. 检查日志开头是否显示 "使用并行差分进化算法"
3. 确认配置中 `method: differential_evolution`

### 问题2：进程启动失败

**可能原因：**
- 内存不足（32个进程同时运行需要大量内存）

**解决：**
修改 `calibration_config.yaml`：
```yaml
optimization:
  options:
    popsize: 16  # 降低种群大小
    workers: 16  # 降低并行进程数
```

### 问题3：收敛速度慢

**调整：**
```yaml
optimization:
  options:
    maxiter: 50   # 减少迭代次数
    popsize: 48   # 增加种群大小（提高搜索能力）
```

## 联系与支持

如遇到其他问题，请提供：
1. `calibration_run.log` 的开头部分（配置信息）
2. `htop` 截图
3. `ps aux | grep python` 的输出

---

**最后更新：** 2025/01/20
**版本：** v3.0 - 进程并行方案

