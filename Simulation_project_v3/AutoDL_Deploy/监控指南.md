# AutoDL任务监控与自动关机指南

当您的电脑关机后，AutoDL服务器上的代码会继续运行。本指南教您如何监控和管理远程任务。

---

## 📱 方案1：使用手机监控（最推荐）

### 方式A：手机SSH客户端（最方便）

#### Android用户

1. **下载Termux或JuiceSSH**
   - Termux（免费）：https://f-droid.org/en/packages/com.termux/
   - JuiceSSH（推荐）：在应用商店搜索"JuiceSSH"

2. **配置连接**
   - 打开应用
   - 添加新连接
   - 输入AutoDL实例的IP、端口、用户名、密码

3. **随时查看**
   ```bash
   # 查看监控报告
   cd Simulation_project_v3
   ./monitor_script.sh
   
   # 查看实时日志
   tail -f OUTPUT/calibration/calibration_run.log
   
   # 重新连接到screen会话
   screen -r calibration
   ```

#### iPhone用户

1. **下载Termius或Shelly**
   - Termius（推荐，免费版够用）
   - Shelly

2. **操作方式同Android**

---

## 💻 方案2：使用另一台电脑监控

如果您有另一台电脑（或者到图书馆、实验室）：

```bash
# 使用SSH连接
ssh root@您的AutoDL实例IP

# 进入项目目录
cd Simulation_project_v3

# 查看监控报告
./monitor_script.sh

# 查看进度
cat OUTPUT/calibration/progress_report.txt
```

---

## 🌐 方案3：AutoDL Web控制台（最简单但信息少）

1. **登录AutoDL网站**：https://www.autodl.com
2. **进入控制台**
3. **查看实例状态**：
   - CPU使用率（如果接近100%说明在运行）
   - 运行时长
4. **打开JupyterLab**（如果AutoDL提供）：
   - 可以直接在浏览器查看文件
   - 查看 `OUTPUT/calibration/calibration_history.csv` 文件大小

---

## ⏰ 方案4：定时生成监控报告

在AutoDL服务器上设置定时任务，自动生成报告：

```bash
# 在服务器上执行
cd Simulation_project_v3

# 创建定时监控脚本
cat > auto_monitor.sh << 'EOF'
#!/bin/bash
while true; do
    ./monitor_script.sh > OUTPUT/calibration/latest_status.txt
    sleep 300  # 每5分钟更新一次
done
EOF

chmod +x auto_monitor.sh

# 在后台运行监控
screen -dmS monitor ./auto_monitor.sh
```

然后您随时可以：
- 用手机SSH查看 `OUTPUT/calibration/latest_status.txt`
- 或在AutoDL的JupyterLab中打开这个文件

---

## 📧 方案5：任务完成通知（高级）

### 选项A：使用企业微信/钉钉Webhook

1. **获取Webhook地址**：
   - 企业微信：创建群聊机器人
   - 钉钉：创建群聊机器人
   - 复制Webhook URL

2. **配置通知脚本**：
   ```bash
   # 编辑 email_notify.sh
   vim email_notify.sh
   
   # 修改第14行的WEBHOOK_URL为您的地址
   WEBHOOK_URL="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
   ```

3. **在后台运行监控**：
   ```bash
   chmod +x email_notify.sh
   screen -dmS notify ./email_notify.sh
   ```

4. **任务完成后会自动发送通知到您的微信/钉钉**

### 选项B：使用Server酱（推荐国内用户）

1. **注册Server酱**：https://sct.ftqq.com/
2. **获取SendKey**
3. **创建通知脚本**：

```bash
cat > notify_completion.sh << 'EOF'
#!/bin/bash

SENDKEY="YOUR_SENDKEY"  # 替换为您的SendKey

while true; do
    if [ -f "OUTPUT/calibration/calibrated_parameters.yaml" ]; then
        # 任务完成，发送通知
        curl -X POST "https://sctapi.ftqq.com/${SENDKEY}.send" \
            -d "title=校准任务完成" \
            -d "desp=您的校准任务已完成，请及时下载结果并关闭实例"
        echo "通知已发送"
        break
    fi
    sleep 300  # 每5分钟检查一次
done
EOF

chmod +x notify_completion.sh
screen -dmS notify ./notify_completion.sh
```

---

## 🔍 如何判断任务是否完成？

### 方法1：检查关键文件（最可靠）

```bash
# SSH连接到服务器后
cd Simulation_project_v3

# 检查是否生成了结果文件
ls -lh OUTPUT/calibration/calibrated_parameters.yaml
```

**如果文件存在** → 任务完成！  
**如果显示"No such file"** → 还在运行

### 方法2：查看日志最后几行

```bash
tail -20 OUTPUT/calibration/calibration_run.log
```

**如果看到**：
```
优化完成
最优SMM距离: 0.xxxxxx
校准结束时间: 2025/10/xx xx:xx
```
→ 任务完成！

### 方法3：查看进程

```bash
ps aux | grep test_calibration
```

**如果有输出** → 还在运行  
**如果没有输出** → 已停止（可能完成或出错）

### 方法4：查看评估次数

```bash
wc -l OUTPUT/calibration/calibration_history.csv
```

记住这个数字，过段时间再查看：
- **数字增加** → 正在运行
- **数字不变** → 可能完成或卡住

---

## ⚡ 第三个问题：如何及时关闭实例？

### 方案1：手动关闭（最安全）

1. **确认任务完成**：
   ```bash
   # 使用手机SSH或其他设备连接
   cd Simulation_project_v3
   ls -lh OUTPUT/calibration/calibrated_parameters.yaml
   ```

2. **下载结果**：
   - 使用WinSCP（从任何联网电脑）
   - 或使用scp命令
   - 或先不下载，AutoDL会保留数据

3. **在AutoDL网站关闭实例**：
   - 登录 https://www.autodl.com
   - 控制台 → 找到实例
   - 点击"关机"按钮

4. **确认关机**：
   - 状态变为"已关机"
   - 计费停止

### 方案2：设置自动关机（高级用户）

```bash
# 创建自动关机脚本
cat > auto_shutdown.sh << 'EOF'
#!/bin/bash

# 等待任务完成后自动关机

while true; do
    # 检查是否完成
    if [ -f "OUTPUT/calibration/calibrated_parameters.yaml" ]; then
        echo "任务完成，准备关机..."
        
        # 等待5分钟（确保文件写入完成）
        sleep 300
        
        # 关机（需要root权限）
        sudo shutdown -h now
        break
    fi
    
    sleep 300  # 每5分钟检查一次
done
EOF

chmod +x auto_shutdown.sh

# 在后台运行
screen -dmS autoshutdown ./auto_shutdown.sh
```

**⚠️ 警告**：
- 自动关机可能导致数据未完全保存
- 建议手动关机更安全
- 如果要用自动关机，确保设置足够的等待时间

---

## 🎯 推荐的完整监控流程

### 启动阶段（在电脑上）

```bash
# 1. 启动校准
./run_calibration.sh

# 2. 启动监控报告生成
chmod +x monitor_script.sh
screen -dmS monitor bash -c "
    while true; do
        ./monitor_script.sh > OUTPUT/calibration/latest_status.txt 2>&1
        sleep 300
    done
"

# 3. （可选）启动通知
./notify_completion.sh

# 4. 分离所有screen会话
# Ctrl+A, D

# 5. 关闭本地电脑
```

### 监控阶段（用手机或其他设备）

**每隔几小时检查一次**：

```bash
# 方法1：查看监控报告
ssh root@AutoDL实例IP
cd Simulation_project_v3
cat OUTPUT/calibration/latest_status.txt

# 方法2：快速检查
ls -lh OUTPUT/calibration/calibrated_parameters.yaml
```

### 完成阶段

1. **确认完成**
2. **下载结果** （可以等到有电脑时）
3. **关闭实例** （重要！节省费用）

---

## 💡 省钱小技巧

1. **任务完成立即关机**
   - 每小时0.2-0.3元
   - 多放1天 = 多花5-7元

2. **使用关机而非释放**
   - 关机：数据保留，不计费
   - 释放：数据删除
   - 建议先关机，确认结果无误后再释放

3. **设置预算告警**
   - AutoDL控制台可以设置余额告警
   - 余额低于10元时会通知

4. **定时检查**
   - 设置手机闹钟，每4-6小时检查一次
   - 避免任务完成后忘记关机

---

## ✅ 快速命令参考卡

```bash
# 【监控命令】
./monitor_script.sh          # 生成监控报告
tail -f 日志文件             # 实时查看日志
ps aux | grep python         # 查看Python进程
screen -r calibration        # 重连到主任务

# 【检查完成】
ls -lh OUTPUT/calibration/calibrated_parameters.yaml  # 检查结果
wc -l OUTPUT/calibration/calibration_history.csv      # 查看评估次数

# 【Screen管理】
screen -ls                   # 列出所有会话
screen -r 会话名              # 重新连接
Ctrl+A, D                    # 分离会话

# 【下载文件（从本地PowerShell）】
scp -r root@IP:/root/Simulation_project_v3/OUTPUT/calibration ./
```

---

## 📞 遇到问题？

### 常见问题

**Q: 手机SSH连接不上？**
- 检查实例是否还在运行
- 确认IP地址和端口正确
- 尝试换个网络（可能是防火墙）

**Q: 看到进程但没有输出？**
- 可能卡住了，查看日志：`tail -100 OUTPUT/calibration/calibration_run.log`
- 检查是否内存不足：`free -h`

**Q: 不知道任务还要多久？**
- 查看评估次数进度（见上文）
- 通常10-20小时完成

**Q: 关机后发现还没完成？**
- 再次开机，screen会话会保留（如果您设置了持久化）
- 数据会保留，可以继续

---

**总结**：推荐使用手机SSH（JuiceSSH/Termius）+ 监控脚本，每隔几小时检查一次，任务完成后及时在AutoDL网站关闭实例！

