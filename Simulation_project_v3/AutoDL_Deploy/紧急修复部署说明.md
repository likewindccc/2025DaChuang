# 紧急修复：闭包序列化问题

## 问题说明

运行校准时出现错误：`Can't pickle local object 'SMMCalibrator._create_mfg_solver.<locals>.mfg_solver'`

**原因：** Python标准的`pickle`无法序列化嵌套函数（闭包），导致无法在多进程间传递目标函数。

**解决方案：** 使用`dill`库替代`pickle`进行序列化。

---

## 部署步骤

### 1. 在AutoDL服务器上执行

```bash
# 连接到AutoDL
ssh root@connect.{区域}.seetacloud.com

# 进入项目目录
cd /root/Simulation_project_v3

# 安装dill库
bash AutoDL_Deploy/install_dill.sh
```

### 2. 从本地上传修改的文件

在**本地Windows**上运行（PowerShell）：

```powershell
cd "D:\Python\2025DaChuang\Simulation_project_v3"

# 上传修复后的核心文件
scp MODULES/CALIBRATION/smm_calibrator.py root@connect.{区域}.seetacloud.com:/root/Simulation_project_v3/MODULES/CALIBRATION/

# 上传安装脚本（如果还没上传）
scp AutoDL_Deploy/install_dill.sh root@connect.{区域}.seetacloud.com:/root/Simulation_project_v3/AutoDL_Deploy/

# 上传更新的requirements.txt
scp requirements.txt root@connect.{区域}.seetacloud.com:/root/Simulation_project_v3/
```

### 3. 重新运行校准

```bash
# 在AutoDL服务器上
cd /root/Simulation_project_v3

# 方法1：后台运行
nohup bash AutoDL_Deploy/force_parallel_run.sh > calibration.log 2>&1 &

# 方法2：screen会话
screen -S calibration
bash AutoDL_Deploy/force_parallel_run.sh
# 按 Ctrl+A 然后 D 分离
```

---

## 修改说明

### 修改的文件

1. **`MODULES/CALIBRATION/smm_calibrator.py`**
   - 导入`dill`库
   - 设置`multiprocessing`使用`dill.Pickler`
   - 修复闭包序列化问题

2. **`requirements.txt`**
   - 添加`dill>=0.3.8`

### 关键代码改动

```python
# 使用dill来序列化，支持闭包
import dill
import multiprocessing

# 设置multiprocessing使用dill
multiprocessing.reduction.ForkingPickler = dill.Pickler
multiprocessing.reduction.dump = dill.dump
```

---

## 验证安装

```bash
# 检查dill是否安装成功
python3 -c "import dill; print(f'dill版本: {dill.__version__}')"

# 应该输出类似：dill版本: 0.3.8
```

---

## 预期效果

- ✅ 不再出现`Can't pickle`错误
- ✅ 128个进程正常并行运行
- ✅ CPU利用率接近12800%
- ✅ 校准过程顺利进行

---

## 如果仍有问题

可以尝试检查：

1. **dill是否正确安装：**
   ```bash
   pip3 show dill
   ```

2. **Python版本兼容性：**
   ```bash
   python3 --version  # 应该是3.10+
   ```

3. **查看详细错误日志：**
   ```bash
   tail -f calibration.log
   ```

