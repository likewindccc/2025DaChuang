# 用户需求确认文档 - Simulation_project_v3

**项目名称**: 农村女性就业市场MFG模拟系统 v3.0  
**创建日期**: 2025-10-08  
**状态**: 已确认  
**版本**: 2.0

---

## 目录

1. [项目概述](#1-项目概述)
2. [整体架构设计](#2-整体架构设计)
3. [各模块详细设计](#3-各模块详细设计)
4. [数据流转](#4-数据流转)
5. [技术选型](#5-技术选型)
6. [开发计划](#6-开发计划)
7. [文件组织结构](#7-文件组织结构)
8. [待确认问题](#8-待确认问题)

---

## 1. 项目概述

### 1.1 项目背景

基于"求是学术"项目申报书：探究中国农村女性就业市场的动态演化机制，融合平均场博弈(MFG)与基于主体建模(ABM)思想。

### 1.2 核心研究问题

1. 农村女性如何动态调整努力水平以提高就业机会？
2. 个体决策与宏观市场状态如何相互作用？
3. 如何设计最优政策组合促进农村女性就业？

### 1.3 v3版本目标

- **简洁性**: 消除v2版本的过度复杂设计
- **清晰性**: 明确的模块职责划分
- **严格性**: 严格遵守项目开发规则
- **可维护性**: 易于理解和扩展的代码结构

---

## 2. 整体架构设计

### 2.1 目录结构

```
Simulation_project_v3/
│
├── CONFIG/                    # 配置文件目录
│   ├── population_config.yaml    # 人口分布模块配置
│   ├── logistic_config.yaml      # 匹配模块配置
│   ├── mfg_config.yaml           # MFG模块配置
│   ├── simulator_config.yaml     # 模拟器配置
│   ├── calibration_config.yaml   # 校准模块配置
│   └── global_config.yaml        # 全局通用配置
│
├── MODULES/                   # 核心开发模块
│   ├── POPULATION/           # 模块1: 人口分布
│   │   ├── __init__.py
│   │   ├── labor_distribution.py      # 劳动力分布生成
│   │   ├── enterprise_distribution.py # 企业分布生成
│   │   └── utils.py                   # 模块工具函数
│   │
│   ├── LOGISTIC/             # 模块2: 匹配与回归
│   │   ├── __init__.py
│   │   ├── virtual_market.py          # 虚拟市场个体生成
│   │   ├── gs_matching.py             # GS匹配算法
│   │   ├── match_function.py          # 匹配函数回归
│   │   └── utils.py
│   │
│   ├── MFG/                  # 模块3: 平均场博弈
│   │   ├── __init__.py
│   │   ├── bellman_solver.py          # 贝尔曼方程求解
│   │   ├── kfe_solver.py              # KFE演化求解
│   │   ├── equilibrium_solver.py      # 均衡求解主控制
│   │   └── utils.py
│   │
│   ├── SIMULATOR/            # 模块4: 模拟器
│   │   ├── __init__.py
│   │   ├── market_simulator.py        # 市场模拟主程序
│   │   ├── policy_analyzer.py         # 政策分析器
│   │   └── utils.py
│   │
│   └── CALIBRATION/          # 模块5: 参数校准
│       ├── __init__.py
│       ├── objective_function.py      # 目标函数
│       ├── optimizer.py               # 优化算法（遗传算法等）
│       └── utils.py
│
├── DATA/                      # 数据目录
│   ├── raw/                   # 原始数据
│   │   └── charls_data.csv   # CHARLS调研数据
│   │
│   └── processed/             # 预处理后的数据
│       ├── labor_data.csv    # 劳动力数据
│       └── enterprise_data.csv # 企业数据（文献数据）
│
├── OUTPUT/                    # 输出结果目录
│   ├── population/            # 人口分布输出
│   ├── matching/              # 匹配结果输出
│   ├── mfg/                   # MFG均衡结果
│   ├── simulation/            # 模拟结果
│   ├── calibration/           # 校准结果
│   └── figures/               # 可视化图表
│
├── DOCS/                      # 文档目录
│   ├── 用户需求确认文档.md    # 本文档
│   ├── 开发规范说明.md        # 开发规范
│   ├── 模块接口文档.md        # 各模块接口说明
│   ├── Change_Log.md          # 修改日志
│   └── README.md              # 项目说明
│
├── TESTS/                     # 测试目录
│   ├── test_population.py
│   ├── test_logistic.py
│   ├── test_mfg.py
│   ├── test_simulator.py
│   └── test_calibration.py
│
├── .gitignore                 # Git忽略规则
└── requirements.txt           # 依赖清单
```

### 2.2 模块依赖关系

```
CALIBRATION (模块5)
    ↓ 调用
SIMULATOR (模块4)
    ↓ 调用
MFG (模块3)
    ↓ 调用
LOGISTIC (模块2)
    ↓ 调用
POPULATION (模块1)
```

**依赖原则**: 
- 高层模块依赖低层模块
- 低层模块不依赖高层模块
- 每个模块独立可测试

---

## 3. 各模块详细设计

### 3.1 模块1: POPULATION (人口分布)

#### 职责
基于预处理的数据，构建劳动力与企业的分布模型（不生成具体个体，只建立分布）。

#### 输入
- `DATA/processed/labor_data.csv`: 劳动力预处理数据
- `DATA/processed/enterprise_data.csv`: 企业预处理数据（来自文献）
- `CONFIG/population_config.yaml`: 配置参数

#### 输出
- 劳动力分布模型参数（Copula参数、边际分布参数）
- 企业分布模型参数（均值向量、协方差矩阵）
- 保存到 `OUTPUT/population/`

#### 核心功能
1. **劳动力分布建模** (`labor_distribution.py`)
   - 使用Copula理论建立4维联合分布 (T, S, D, W)
   - 估计边际分布参数
   - 估计依赖结构（Copula参数）

2. **企业分布建模** (`enterprise_distribution.py`)
   - 使用4维正态分布建模 (T_req, S_req, D_req, W_offer)
   - 参数来自文献或初始设定（后续通过校准调整）

#### 关键接口
```python
# labor_distribution.py
class LaborDistribution:
    def fit(data: pd.DataFrame) -> None
        """拟合劳动力分布"""
    
    def get_params() -> dict
        """获取分布参数"""
    
    def save_params(filepath: str) -> None
        """保存参数"""

# enterprise_distribution.py
class EnterpriseDistribution:
    def set_params(mean: np.ndarray, cov: np.ndarray) -> None
        """设置分布参数"""
    
    def get_params() -> dict
        """获取分布参数"""
```

#### 设计决策
1. 劳动力分布使用Copula理论（已确认）
2. 企业分布使用4维正态分布（已确认）
3. 边际分布估计方法：核密度估计
4. Copula类型：Gaussian Copula

---

### 3.2 模块2: LOGISTIC (匹配与匹配函数)

#### 职责
基于人口分布模块的分布参数，生成虚拟双边市场个体，进行GS匹配，通过多轮模拟得到匹配数据，并回归得到匹配函数λ(x,a,θ)。

#### 输入
- 人口分布参数（从模块1）
- `CONFIG/logistic_config.yaml`: 配置参数

#### 输出
- 匹配函数参数
- 匹配模拟数据
- 保存到 `OUTPUT/matching/`

#### 核心功能
1. **虚拟市场生成** (`virtual_market.py`)
   - 从分布中采样生成虚拟劳动力
   - 从分布中采样生成虚拟企业
   - 支持批量生成（多轮模拟）

2. **GS匹配算法** (`gs_matching.py`)
   - 实现Gale-Shapley稳定匹配
   - 计算双边偏好
   - **有限轮次匹配**模拟真实摩擦

3. **匹配函数回归** (`match_function.py`)
   - 收集多轮模拟数据
   - Logit回归估计λ参数
   - 生成Numba优化的匹配函数

#### 关键接口
```python
# virtual_market.py
def generate_virtual_laborers(
    distribution_params: dict,
    n_laborers: int
) -> pd.DataFrame
    """生成虚拟劳动力"""

def generate_virtual_enterprises(
    distribution_params: dict,
    n_enterprises: int
) -> pd.DataFrame
    """生成虚拟企业"""

# gs_matching.py
def gs_matching(
    laborers: pd.DataFrame,
    enterprises: pd.DataFrame,
    max_rounds: int = None
) -> pd.DataFrame
    """GS匹配，返回匹配结果"""

# match_function.py
def estimate_match_function(
    simulation_data: pd.DataFrame
) -> dict
    """回归估计匹配函数参数"""

@njit
def match_probability(
    x: np.ndarray,
    a: float,
    theta: float,
    params: np.ndarray
) -> float
    """Numba优化的匹配概率函数"""
```

#### 设计决策
1. 每轮模拟生成10,000劳动力（企业数量由theta动态计算）
2. 总共模拟150轮，涵盖不同θ场景
3. 有限轮次匹配：max_rounds=32（已调优）
4. 匹配函数形式：Logit模型
5. 控制变量：age、education、children（综合为sigma指标）

---

### 3.3 模块3: MFG (平均场博弈)

#### 职责
基于匹配函数，构建平均场博弈模型，求解均衡状态（值函数、策略函数、人口分布）。

#### 输入
- 匹配函数参数（从模块2）
- `CONFIG/mfg_config.yaml`: MFG参数配置

#### 输出
- MFG均衡结果（值函数、策略、分布）
- 宏观指标（失业率、市场紧张度等）
- 保存到 `OUTPUT/mfg/`

#### 核心功能
1. **贝尔曼方程求解** (`bellman_solver.py`)
   - 值迭代算法
   - 求解失业者和就业者的值函数
   - 求解最优努力策略

2. **KFE演化求解** (`kfe_solver.py`)
   - Kolmogorov前向方程
   - 人口分布演化
   - 失业率和就业率计算

3. **均衡求解主控制** (`equilibrium_solver.py`)
   - 交替迭代贝尔曼+KFE
   - 收敛判断
   - 均衡结果输出

#### 关键接口
```python
# equilibrium_solver.py
class MFGSolver:
    def __init__(config: dict, match_function_params: dict)
        """初始化MFG求解器"""
    
    def solve() -> dict
        """求解MFG均衡，返回均衡结果"""
    
    def get_unemployment_rate() -> float
        """获取均衡失业率"""
```

#### 设计决策
1. 状态空间：4维(T,S,D,W)保持连续，不离散化
2. 方法：基于个体的蒙特卡洛模拟（N=10000个体）
3. 值迭代：最大500次，收敛阈值tol=1e-4
4. 均衡迭代：最大100次，相对收敛阈值1%
5. 优化：Numba JIT加速核心计算（预期10-30倍加速）

---

### 3.4 模块4: SIMULATOR (模拟器)

#### 职责
基于不同的初始参数设定，调用MFG模块进行模拟，分析不同政策场景下的市场演化。

#### 输入
- 匹配函数参数（从模块2）
- MFG参数配置
- 政策参数配置
- `CONFIG/simulator_config.yaml`

#### 输出
- 不同场景下的模拟结果
- 政策效果对比分析
- 保存到 `OUTPUT/simulation/`

#### 核心功能
1. **市场模拟** (`market_simulator.py`)
   - 调用MFG求解器
   - 批量运行多个场景
   - 结果汇总和比较

2. **政策分析** (`policy_analyzer.py`)
   - 培训政策分析
   - 补贴政策分析
   - 政策组合优化

#### 关键接口
```python
# market_simulator.py
class MarketSimulator:
    def run_scenario(scenario_params: dict) -> dict
        """运行单个场景"""
    
    def run_batch(scenarios: list) -> pd.DataFrame
        """批量运行多个场景"""

# policy_analyzer.py
def analyze_training_policy(params: dict) -> dict
    """分析培训政策效果"""

def analyze_subsidy_policy(params: dict) -> dict
    """分析补贴政策效果"""
```

#### 待开发
模块4和模块5将在MFG模块稳定后开始开发。

---

### 3.5 模块5: CALIBRATION (参数校准)

#### 职责
使用优化算法校准模型参数，使模拟结果与真实数据/文献数据匹配。

#### 输入
- 真实数据的目标指标（失业率、工资水平等）
- 初始参数范围
- `CONFIG/calibration_config.yaml`

#### 输出
- 校准后的参数
- 校准过程记录
- 保存到 `OUTPUT/calibration/`

#### 核心功能
1. **目标函数** (`objective_function.py`)
   - 定义模拟指标与真实指标的差距
   - 加权多目标函数

2. **优化算法** (`optimizer.py`)
   - 遗传算法（DEAP库）
   - 参数搜索和迭代
   - 最优参数输出

#### 关键接口
```python
# objective_function.py
def compute_objective(params: dict) -> float
    """计算目标函数值（误差）"""

# optimizer.py
class ParameterCalibrator:
    def calibrate(
        param_bounds: dict,
        target_metrics: dict
    ) -> dict
        """执行参数校准"""
```

#### 待开发
模块5将使用SMM（模拟矩匹配）方法校准结构参数，使模拟结果匹配真实数据矩。

---

## 4. 数据流转

### 4.1 完整流程

```
原始数据 (DATA/raw/)
    ↓
数据预处理 (手工或脚本)
    ↓
预处理数据 (DATA/processed/)
    ↓
模块1: POPULATION - 建立分布模型
    ↓ 输出：分布参数
模块2: LOGISTIC - 生成虚拟市场 + GS匹配 + 回归
    ↓ 输出：匹配函数λ
模块3: MFG - 求解均衡
    ↓ 输出：均衡状态
模块4: SIMULATOR - 政策模拟
    ↓ 输出：模拟结果
模块5: CALIBRATION - 参数校准
    ↓ 输出：校准参数
返回模块1 - 更新参数 - 重新迭代
```

### 4.2 核心数据格式

#### 劳动力数据
```python
# DATA/processed/labor_data.csv
columns = [
    'id',           # 个体ID
    'T',            # 每周工作时长
    'S',            # 工作能力评分
    'D',            # 数字素养评分
    'W',            # 每月期望收入
    'age',          # 年龄
    'education',    # 教育年限
    # ... 其他控制变量
]
```

#### 企业数据
```python
# DATA/processed/enterprise_data.csv
columns = [
    'id',           # 企业ID
    'T_req',        # 工作时长要求
    'S_req',        # 技能要求
    'D_req',        # 数字化要求
    'W_offer',      # 提供薪资
]
```

#### 匹配结果数据
```python
# 中间数据格式
columns = [
    'laborer_id',
    'enterprise_id',
    'matched',      # 0/1
    'theta',        # 市场紧张度
    'effort',       # 努力水平
    # ... 劳动力和企业的特征
]
```

---

## 5. 技术选型

### 5.1 核心依赖库

```python
# requirements.txt
numpy>=1.26.0          # 数值计算
pandas>=2.0.0          # 数据处理
scipy>=1.11.0          # 科学计算
numba>=0.59.0          # JIT加速（必需）
copulas>=0.12.0        # Copula建模
statsmodels>=0.14.0    # 统计建模（Logit回归）
deap>=1.4.0            # 遗传算法
pyyaml>=6.0            # 配置文件
matplotlib>=3.8.0      # 可视化
seaborn>=0.13.0        # 高级可视化
pytest>=8.0.0          # 测试框架
```

### 5.2 Numba优化策略

**必须优化的函数**:
1. 匹配概率函数λ
2. GS匹配算法的偏好计算
3. 贝尔曼方程迭代
4. KFE演化步骤

**优化原则**:
- 所有热点计算必须使用Numba
- 目标加速比>10x
- 保留纯Python版本作为备用

### 5.3 配置管理

**格式**: YAML  
**原则**: 
- 每个模块一个配置文件
- 全局配置单独存放
- 配置与代码分离

---

## 6. 开发计划

### 6.1 开发阶段

| 阶段 | 任务 | 预计时间 | 交付物 |
|------|------|---------|--------|
| **Phase 0** | 需求确认 | 1天 | 确认后的需求文档 |
| **Phase 1** | 基础框架 | 2天 | 配置系统、工具函数 |
| **Phase 2** | 模块1开发 | 3天 | POPULATION模块 |
| **Phase 3** | 模块2开发 | 4天 | LOGISTIC模块 |
| **Phase 4** | 模块3开发 | 5天 | MFG模块 |
| **Phase 5** | 模块4开发 | 2天 | SIMULATOR模块 |
| **Phase 6** | 模块5开发 | 3天 | CALIBRATION模块 |
| **Phase 7** | 集成测试 | 2天 | 完整系统 |
| **Phase 8** | 文档完善 | 2天 | 所有文档 |

**总计**: 约24天（约3-4周）

### 6.2 开发原则

1. **每次只开发一个文件**（规则三）
2. **每个阶段结束需审查**
3. **严格测试驱动开发**
4. **及时更新Change_Log.md**（规则六）

---

## 7. 文件组织结构

### 7.1 Python包结构

每个模块都是独立的Python包：

```python
MODULES/
├── __init__.py           # 顶层包
├── POPULATION/
│   ├── __init__.py       # 导出主要类
│   ├── labor_distribution.py
│   ├── enterprise_distribution.py
│   └── utils.py
├── LOGISTIC/
│   ├── __init__.py
│   ├── virtual_market.py
│   ├── gs_matching.py
│   ├── match_function.py
│   └── utils.py
# ... 其他模块类似
```

### 7.2 配置文件示例

```yaml
# CONFIG/global_config.yaml
project:
  name: "Simulation_project_v3"
  version: "3.0"
  random_seed: 42

paths:
  data_dir: "DATA"
  output_dir: "OUTPUT"
  
logging:
  level: "INFO"
  save_to_file: true
```

### 7.3 输出文件组织

```
OUTPUT/
├── population/
│   ├── labor_distribution_params.pkl
│   └── enterprise_distribution_params.pkl
├── matching/
│   ├── match_function_params.json
│   └── simulation_data.csv
├── mfg/
│   ├── equilibrium_result.npz
│   └── convergence_history.csv
├── simulation/
│   └── scenario_results.csv
└── calibration/
    └── calibrated_params.yaml
```

---

## 8. 实施情况总结

### 8.1 已完成的核心决策

1. **模块1 - POPULATION**:
   - 边际分布估计：核密度估计
   - Copula类型：Gaussian Copula
   - 离散变量：经验分布

2. **模块2 - LOGISTIC**:
   - 虚拟市场规模：10,000劳动力/轮
   - 总模拟轮数：150轮
   - 有限轮次匹配：max_rounds=32（已调优）
   - 控制变量：age、education、children

3. **模块3 - MFG**:
   - 状态空间：4维连续（T,S,D,W）
   - 方法：基于个体的蒙特卡洛（N=10000）
   - 收敛标准：相对阈值1%
   - 优化：Numba JIT全面应用

### 8.2 开发进度

- 模块1：已完成（100%）
- 模块2：已完成（100%）
- 模块3：核心完成（85%），收敛性优化中
- 模块4：待开发
- 模块5：待开发

### 8.3 技术实现

1. 测试覆盖：15个测试脚本
2. 性能优化：Numba加速（10-30倍）
3. 文档完善：Change_Log详细记录17次修改
4. 代码规范：PEP8 + 完整中文注释

---

## 9. 与v2版本的主要区别

| 维度 | v2版本 | v3版本 |
|------|--------|--------|
| **目录结构** | 深层嵌套，src/core/modules | 扁平化，顶层MODULES |
| **模块数量** | 5个模块+核心层 | 5个模块，无核心层 |
| **复杂度** | 过度设计，稀疏网格等 | 简化设计，优先可用性 |
| **配置管理** | config/default/experiments | 扁平化CONFIG目录 |
| **数据管理** | data/input/output | DATA和OUTPUT分离 |
| **职责划分** | 模块间有交叉 | 职责清晰，无重叠 |

**核心理念差异**:
- v2: 追求完美的学术级实现，导致过度复杂
- v3: 追求简洁实用的实现，优先完成功能

---

## 10. 下一步工作计划

### 10.1 短期目标（1-2天）

1. 验证MFG收敛性优化效果
2. 完成MFG模块测试和文档
3. 准备SIMULATOR模块开发

### 10.2 中期目标（1周）

1. 开发SIMULATOR模块
   - 市场模拟主程序
   - 政策分析器
   - 批量场景运行
2. 进行初步的政策模拟实验

### 10.3 长期目标（2周）

1. 开发CALIBRATION模块
   - SMM校准器
   - 参数优化算法
2. 准备真实数据和目标矩
3. 完成系统整体测试
4. 撰写技术文档和研究报告

---

**文档状态**: 已确认  
**创建日期**: 2025-10-08  
**最后更新**: 2025-10-17

---

## 附录

### A. 参考v2的优秀设计

保留v2的以下优点：
- Numba优化策略
- PEP8代码规范
- 完整的文档字符串
- Git + Change_Log混合管理

### B. 摒弃v2的过度设计

避免v2的以下问题：
- 过深的目录嵌套
- 过于复杂的状态空间（稀疏网格）
- 不必要的抽象层（core层）
- 过多的数据结构类

---

**备注**: 本文档基于研究计划和项目实际需求编写，用于指导v3版本开发。

