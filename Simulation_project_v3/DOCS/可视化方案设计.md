# 可视化方案设计文档

## 一、总体设计原则

### 1.1 可视化目标

- **学术展示**：支持论文、报告的高质量图表
- **交互探索**：支持研究过程中的数据探索和分析
- **政策沟通**：支持向政策制定者展示仿真结果

### 1.2 技术栈选择

- **静态图表**：Matplotlib + Seaborn（PNG/PDF，适合论文）
- **交互式图表**：Plotly（HTML，支持缩放、悬停、筛选）
- **动态演示**：Plotly Animation（展示时间演化过程）
- **仪表盘**：HTML + JavaScript（整合多个可视化）

---

## 二、MFG模块可视化方案

### 2.1 价值函数可视化

#### 2.1.1 失业价值函数 V_U(T, S, D, W)

**目的**：展示个体在不同状态下的失业价值

**静态图（Matplotlib）**：

```python
# 输出：VALUE_FUNCTION_VU_heatmap.png
# 展示方式：
#   - 4个子图（固定D和W的不同水平）
#   - X轴: T（劳动供给时间）
#   - Y轴: S（技能水平）
#   - 颜色: V_U的值
#   - 热力图，colorbar显示数值范围
```

**交互式图（Plotly）**：

```python
# 输出：VALUE_FUNCTION_VU_interactive.html
# 功能：
#   - 4D切片可视化（滑块选择D和W的值）
#   - 悬停显示具体数值
#   - 支持3D曲面图切换（T-S平面上的V_U曲面）
```

#### 2.1.2 就业价值函数 V_E(T, S, D, W)

**同V_U的可视化方案**

#### 2.1.3 价值函数差异 ΔV = V_E - V_U

**目的**：展示就业相对于失业的价值增量

**静态图**：

```python
# 输出：VALUE_FUNCTION_delta_heatmap.png
# 展示ΔV在T-S空间的分布
# 正值区域：就业优于失业
# 负值区域：失业优于就业（理论上不应出现）
```

---

### 2.2 最优策略可视化

#### 2.2.1 最优努力水平 a*(T, S, D, W)

**静态图（Matplotlib）**：

```python
# 输出：OPTIMAL_EFFORT_heatmap.png
# 4个子图，展示不同(D,W)组合下a*在T-S空间的分布
# 颜色范围：[0, 1]
```

**交互式图（Plotly）**：

```python
# 输出：OPTIMAL_EFFORT_interactive.html
# 功能：
#   - 滑块选择D和W
#   - 3D曲面图：X=T, Y=S, Z=a*
#   - 悬停显示：(T, S, D, W) -> a* = ?
```

#### 2.2.2 努力水平分布

**静态图**：

```python
# 输出：EFFORT_DISTRIBUTION_histogram.png
# 展示10000个个体的a*分布直方图
# 统计信息：均值、中位数、标准差
```

---

### 2.3 状态更新机制可视化

#### 2.3.1 状态转移示例

**静态图（Matplotlib）**：

```python
# 输出：STATE_UPDATE_illustration.png
# 展示一个个体从t到t+1的状态演化
# 4个子图：
#   - T: 初始 -> 努力 -> 更新后
#   - S: 同上
#   - D: 同上
#   - W: 同上
# 标注努力水平a和gamma参数
```

**动画（Plotly Animation）**：

```python
# 输出：STATE_EVOLUTION_animation.html
# 展示100个个体在20个时间步内的状态演化
# 散点图：X=S, Y=D, 颜色=T, 大小=W
# 播放按钮控制时间演化
```

---

### 2.4 人口分布演化可视化

#### 2.4.1 T分布演化

**静态图（Matplotlib）**：

```python
# 输出：T_DISTRIBUTION_evolution.png
# 多条曲线叠加（不同MFG迭代轮次）
# X轴：T值（小时/周）
# Y轴：密度（KDE）
# 显示均值线（虚线）
```

**交互式图（Plotly）**：

```python
# 输出：T_DISTRIBUTION_evolution.html
# 滑块选择MFG迭代次数（0-50）
# 实时更新直方图和KDE曲线
# 显示统计信息：均值、标准差、中位数
```

#### 2.4.2 四维状态联合分布

**静态图（Matplotlib）**：

```python
# 输出：STATE_JOINT_DISTRIBUTION_pairs.png
# 6个子图（T-S, T-D, T-W, S-D, S-W, D-W的散点图）
# 颜色区分就业/失业状态
```

**交互式图（Plotly）**：

```python
# 输出：STATE_JOINT_DISTRIBUTION_3D.html
# 3D散点图：X=T, Y=S, Z=D
# 颜色：W值
# 大小：就业概率
# 支持旋转、缩放
```

---

### 2.5 匹配与分离可视化

#### 2.5.1 匹配概率 λ(x', σ, θ)

**静态图（Matplotlib）**：

```python
# 输出：MATCHING_PROBABILITY_heatmap.png
# 固定θ（市场紧度）
# X轴：劳动者综合质量x'
# Y轴：企业需求σ
# 颜色：匹配概率λ
```

**交互式图（Plotly）**：

```python
# 输出：MATCHING_PROBABILITY_3D.html
# 3D曲面图：X=x', Y=σ, Z=λ
# 滑块选择θ值（0.5 - 1.5）
```

#### 2.5.2 分离率 μ(x, σ)

**同匹配概率的可视化方案**

---

### 2.6 MFG收敛过程可视化

#### 2.6.1 收敛曲线

**静态图（Matplotlib）**：

```python
# 输出：MFG_CONVERGENCE_curves.png
# 3个子图（上下排列）：
#   1. |ΔV| / |V| vs 迭代次数（对数坐标）
#   2. |Δmean(a)| vs 迭代次数
#   3. |Δu| vs 迭代次数
# 水平虚线标注收敛阈值
```

**交互式图（Plotly）**：

```python
# 输出：MFG_CONVERGENCE_interactive.html
# 多条曲线可切换显示/隐藏
# 悬停显示具体数值
# 收敛点标注
```

---

## 三、CALIBRATION模块可视化方案

### 3.1 校准过程可视化

#### 3.1.1 目标函数历史

**静态图（Matplotlib）**：

```python
# 输出：CALIBRATION_objective_history.png
# X轴：评估次数
# Y轴：SMM距离（对数坐标）
# 红色虚线：当前最优值
# 标注：最终SMM距离
```

**交互式图（Plotly）**：

```python
# 输出：CALIBRATION_objective_history.html
# 散点图：每个评估点
# 颜色：迭代轮次（gradient）
# 悬停：显示参数向量
# 支持缩放、框选
```

#### 3.1.2 参数收敛轨迹

**静态图（Matplotlib）**：

```python
# 输出：CALIBRATION_parameter_traces.png
# 12个子图（每个参数一个）
# X轴：评估次数
# Y轴：参数值
# 红色虚线：边界
# 绿色实线：最终值
```

**交互式图（Plotly）**：

```python
# 输出：CALIBRATION_parameter_traces.html
# 平行坐标图（Parallel Coordinates）
# 每条线代表一次评估
# 颜色：SMM距离（越红越差，越绿越好）
# 可选择参数子集
```

---

### 3.2 参数空间探索可视化

#### 3.2.1 参数相关性

**静态图（Matplotlib）**：

```python
# 输出：CALIBRATION_parameter_correlation.png
# 12×12热力图（参数两两相关性）
# 基于评估历史计算Pearson相关系数
```

#### 3.2.2 参数-目标函数关系

**静态图（Matplotlib）**：

```python
# 输出：CALIBRATION_parameter_sensitivity.png
# 12个子图（每个参数）
# X轴：参数值
# Y轴：SMM距离
# 散点图 + 局部回归曲线（LOWESS）
```

**交互式图（Plotly）**：

```python
# 输出：CALIBRATION_parameter_objective_2D.html
# 下拉菜单选择两个参数
# 2D热力图或散点图
# 颜色：SMM距离
# 标注最优点
```

---

### 3.3 矩拟合质量可视化

#### 3.3.1 目标矩 vs 模拟矩

**静态图（Matplotlib）**：

```python
# 输出：CALIBRATION_moment_fit.png
# 柱状图（并排对比）
# 3组：失业率、平均工资、工资标准差
# 蓝色：目标值
# 橙色：模拟值
# 误差棒：显示差异
```

**交互式图（Plotly）**：

```python
# 输出：CALIBRATION_moment_fit.html
# 雷达图（Radar Chart）
# 归一化后的矩对比
# 两条曲线：目标 vs 模拟
```

#### 3.3.2 矩差异演化

**静态图（Matplotlib）**：

```python
# 输出：CALIBRATION_moment_error_evolution.png
# 3条曲线（每个矩一条）
# X轴：评估次数
# Y轴：|模拟矩 - 目标矩|
```

---

### 3.4 校准结果诊断

#### 3.4.1 残差分析

**静态图（Matplotlib）**：

```python
# 输出：CALIBRATION_residual_analysis.png
# 4个子图：
#   1. 残差 vs 拟合值
#   2. 残差直方图 + 正态分布拟合
#   3. Q-Q图
#   4. 残差 vs 评估次数
```

#### 3.4.2 参数后验分布估计

**静态图（Matplotlib）**：

```python
# 输出：CALIBRATION_parameter_posterior.png
# 12个子图（每个参数的核密度估计）
# 基于评估历史中SMM距离最小的前10%样本
# 垂直线标注最优值
```

---

## 四、SIMULATOR模块可视化方案

### 4.1 政策仿真结果对比

#### 4.1.1 关键指标对比

**静态图（Matplotlib）**：

```python
# 输出：SIMULATION_policy_comparison_bars.png
# 分组柱状图（3组政策 + 基准）
# 指标：失业率、平均工资、平均T、平均S、平均D
```

**交互式图（Plotly）**：

```python
# 输出：SIMULATION_policy_comparison.html
# 雷达图 + 柱状图切换
# 下拉菜单选择政策组合
# 鼠标悬停显示具体数值和变化率
```

#### 4.1.2 分布变化对比

**静态图（Matplotlib）**：

```python
# 输出：SIMULATION_distribution_comparison.png
# 4×3子图矩阵（4个状态变量 × 3个政策）
# 每个子图：基准（灰色虚线）vs 政策（彩色实线）
# KDE曲线
```

---

### 4.2 政策效果动态演化

#### 4.2.1 时间序列可视化

**静态图（Matplotlib）**：

```python
# 输出：SIMULATION_time_series.png
# 多条曲线（不同政策）
# X轴：时间（期）
# Y轴：失业率
# 阴影区域：95%置信区间（多次仿真）
```

**交互式图（Plotly）**：

```python
# 输出：SIMULATION_time_series.html
# 时间序列播放动画
# 滑块控制时间
# 多个指标可切换（失业率、平均工资等）
```

#### 4.2.2 状态空间轨迹

**交互式图（Plotly）**：

```python
# 输出：SIMULATION_state_trajectory_3D.html
# 3D轨迹图：X=T, Y=S, Z=D
# 4条轨迹（基准 + 3个政策）
# 颜色渐变表示时间
# 起点/终点标注
```

---

### 4.3 异质性分析

#### 4.3.1 不同群体的政策效果

**静态图（Matplotlib）**：

```python
# 输出：SIMULATION_heterogeneity_analysis.png
# 分面图（Facet Grid）
# 按初始技能水平分组（低/中/高）
# 每组展示政策效果（失业率变化、工资变化）
```

**交互式图（Plotly）**：

```python
# 输出：SIMULATION_heterogeneity_sunburst.html
# 旭日图（Sunburst Chart）
# 第一层：政策类型
# 第二层：技能水平组
# 第三层：具体指标
# 大小：效果量
```

---

### 4.4 政策成本-收益分析

#### 4.4.1 成本-收益散点图

**静态图（Matplotlib）**：

```python
# 输出：SIMULATION_cost_benefit.png
# X轴：政策成本（归一化）
# Y轴：失业率降低幅度（%）
# 每个点代表一个政策
# 虚线：成本-收益平衡线
# 标注：帕累托前沿
```

**交互式图（Plotly）**：

```python
# 输出：SIMULATION_cost_benefit.html
# 气泡图：X=成本, Y=失业率改善, 大小=工资增长
# 悬停：显示政策详情
# 可切换Y轴指标
```

---

## 五、数据模块可视化方案

### 5.1 初始人口分布

#### 5.1.1 状态变量分布

**静态图（Matplotlib）**：

```python
# 输出：DATA_initial_distribution.png
# 2×2子图：T, S, D, W的直方图 + KDE
# 标注均值、中位数
```

**交互式图（Plotly）**：

```python
# 输出：DATA_initial_distribution.html
# 小提琴图（Violin Plot）
# 显示分位数
# 可点击切换对数坐标
```

#### 5.1.2 Copula结构

**静态图（Matplotlib）**：

```python
# 输出：DATA_copula_structure.png
# 6个散点图（状态变量两两配对）
# 颜色：密度估计
# 显示Spearman相关系数
```

---

### 5.2 企业需求分布

#### 5.2.1 需求向量分布

**静态图（Matplotlib）**：

```python
# 输出：DATA_enterprise_demand.png
# 类似初始人口分布的4个子图
```

#### 5.2.2 劳动者-企业匹配空间

**交互式图（Plotly）**：

```python
# 输出：DATA_matching_space.html
# 3D散点图
# 蓝色点：劳动者
# 红色点：企业需求
# 连线：匹配对
# 支持筛选（按匹配质量）
```

---

## 六、整合仪表盘方案

### 6.1 MFG均衡仪表盘

**输出**：`DASHBOARD_mfg_equilibrium.html`

**布局**：

```
┌─────────────────────────────────────┐
│  MFG均衡求解仪表盘                  │
├──────────────┬──────────────────────┤
│ 控制面板     │  价值函数热力图      │
│ - 选择迭代   │  (可切换V_U/V_E/ΔV)  │
│ - 选择D,W值  │                      │
├──────────────┼──────────────────────┤
│ 最优努力3D图 │  人口分布演化        │
│              │  (KDE + 直方图)      │
├──────────────┴──────────────────────┤
│ 收敛曲线（3个指标）                 │
└─────────────────────────────────────┘
```

**技术实现**：

- Plotly Dash（Python框架）
- 或纯HTML + Plotly.js

---

### 6.2 校准过程仪表盘

**输出**：`DASHBOARD_calibration.html`

**布局**：

```
┌─────────────────────────────────────┐
│  SMM校准过程监控仪表盘              │
├──────────────┬──────────────────────┤
│ 关键指标卡片 │  目标函数历史        │
│ - 当前SMM    │  (散点图 + 趋势线)   │
│ - 评估次数   │                      │
│ - 最优SMM    │                      │
├──────────────┼──────────────────────┤
│ 参数轨迹图   │  矩拟合对比          │
│ (平行坐标)   │  (柱状图/雷达图)     │
├──────────────┴──────────────────────┤
│ 参数-目标函数关系（2D热力图）       │
└─────────────────────────────────────┘
```

---

### 6.3 政策仿真对比仪表盘

**输出**：`DASHBOARD_policy_simulation.html`

**布局**：

```
┌─────────────────────────────────────┐
│  政策仿真结果对比仪表盘             │
├──────────────┬──────────────────────┤
│ 政策选择器   │  关键指标对比        │
│ ☑ 基准       │  (雷达图/柱状图)     │
│ ☑ 政策A      │                      │
│ ☑ 政策B      │                      │
│ ☑ 政策C      │                      │
├──────────────┼──────────────────────┤
│ 时间序列动画 │  分布变化对比        │
│ (失业率演化) │  (小提琴图/箱线图)   │
├──────────────┴──────────────────────┤
│ 成本-收益分析（散点图）             │
└─────────────────────────────────────┘
```

---

## 七、实施优先级

### 第一阶段（当前）：校准完成前

- [ ] MFG收敛过程可视化（静态图）
- [ ] 初始分布可视化（静态图）

### 第二阶段：校准完成后

- [ ] 校准结果可视化（静态图 + 交互式）
- [ ] 矩拟合质量诊断（静态图）
- [ ] 参数空间探索可视化（交互式）
- [ ] 价值函数和策略可视化（静态图）

### 第三阶段：政策仿真后

- [ ] 政策效果对比（静态图 + 交互式）
- [ ] 时间序列演化（动画）
- [ ] 异质性分析（分面图）

### 第四阶段：论文撰写时

- [ ] 高质量静态图打磨（调整配色、字体、分辨率）
- [ ] 整合仪表盘开发（用于答辩展示）

---

## 八、代码组织建议

### 8.1 文件结构

```
MODULES/
└── VISUALIZATION/
    ├── __init__.py
    ├── mfg_visualizer.py       # MFG模块可视化
    ├── calibration_visualizer.py  # 校准可视化
    ├── simulation_visualizer.py   # 仿真可视化
    ├── data_visualizer.py      # 数据可视化
    ├── dashboard_builder.py    # 仪表盘构建
    └── style_config.py         # 统一样式配置
```

### 8.2 样式统一配置

```python
# style_config.py
COLORS = {
    'primary': '#1f77b4',
    'secondary': '#ff7f0e',
    'success': '#2ca02c',
    'danger': '#d62728',
    'policy_A': '#9467bd',
    'policy_B': '#8c564b',
    'policy_C': '#e377c2',
    'baseline': '#7f7f7f'
}

FIGURE_SIZE = {
    'single': (8, 6),
    'double': (12, 5),
    'grid_2x2': (10, 10),
    'wide': (14, 5)
}

FONT_CONFIG = {
    'family': 'SimHei',  # 中文字体
    'title_size': 16,
    'label_size': 12,
    'tick_size': 10
}
```

---

## 九、输出规范

### 9.1 文件命名

- 静态图：`{MODULE}_{CONTENT}_{TYPE}.{png|pdf}`
  - 例：`MFG_value_function_heatmap.png`
- 交互式图：`{MODULE}_{CONTENT}_interactive.html`
  - 例：`CALIBRATION_objective_history_interactive.html`
- 仪表盘：`DASHBOARD_{TOPIC}.html`

### 9.2 输出目录

```
OUTPUT/
├── figures/           # 静态图（PNG/PDF）
│   ├── mfg/
│   ├── calibration/
│   └── simulation/
├── interactive/       # 交互式HTML
│   ├── mfg/
│   ├── calibration/
│   └── simulation/
└── dashboards/        # 整合仪表盘
```

### 9.3 元数据记录

每次生成可视化时，同时生成元数据JSON：

```json
{
    "figure_name": "MFG_value_function_heatmap.png",
    "module": "MFG",
    "content": "价值函数热力图",
    "timestamp": "2025-10-20 15:30:00",
    "parameters": {
        "D_fixed": 5.0,
        "W_fixed": 4500.0
    },
    "data_source": "OUTPUT/equilibrium_results/equilibrium_individuals.csv"
}
```

---

## 十、待讨论问题

1. **交互式可视化技术选型**：Plotly vs Bokeh vs D3.js？ 这几个有什么区别和差异吗？
2. **仪表盘部署**：本地HTML文件 vs Dash在线服务？  能做成一个网站之类的吗？还是说只能做成HTML？
3. **论文图表风格**：是否需要符合特定期刊的格式要求（如黑白打印友好）？ 不需要
4. 
5. **动画保存格式**：GIF vs MP4 vs HTML？ HTML
6. **高分辨率图导出**：DPI设置（300 for paper, 150 for screen）？ 300dpi

---

**文档版本**：v1.0
**创建时间**：2025/10/20
**最后更新**：2025/10/20
**负责人**：项目组
