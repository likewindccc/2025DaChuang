# EconLab打包指南

## 打包前准备

### 1. 确保所有依赖已安装

```bash
# 激活虚拟环境
D:\Python\2025DaChuang\venv\Scripts\Activate.ps1

# 检查关键库
python -c "import PyQt6; print('PyQt6: OK')"
python -c "import numba; print('Numba: OK')"
python -c "import matplotlib; print('Matplotlib: OK')"
```

### 2. 安装PyInstaller

```bash
pip install pyinstaller
```

## 打包步骤

### 方法1：使用spec文件打包（推荐）

```bash
# 进入项目目录
cd D:\Python\2025DaChuang\Simulation_project_v3

# 使用spec文件打包
pyinstaller app.spec

# 生成的exe在 dist/ 目录
```

### 方法2：命令行打包

```bash
pyinstaller --name=EconLab ^
    --onefile ^
    --windowed ^
    --add-data "CONFIG;CONFIG" ^
    --add-data "GUI/resources;GUI/resources" ^
    --add-data "OUTPUT/logistic/match_function_model.pkl;OUTPUT/logistic" ^
    --add-data "OUTPUT/population/labor_distribution_params.pkl;OUTPUT/population" ^
    --hidden-import numba ^
    --hidden-import PyQt6 ^
    --exclude-module pytest ^
    GUI/app.py
```

## 打包选项说明

- `--onefile`: 打包为单个exe文件
- `--windowed`: 不显示控制台窗口
- `--add-data`: 添加数据文件（格式：源路径;目标路径）
- `--hidden-import`: 添加隐式导入的模块
- `--exclude-module`: 排除不必要的模块
- `--upx-dir`: UPX压缩工具路径（可选）

## 测试打包后的exe

```bash
# 运行生成的exe
dist\EconLab.exe

# 检查清单：
# [ ] 应用能正常启动
# [ ] 界面正常显示
# [ ] 可以加载配置文件
# [ ] 可以运行MFG仿真
# [ ] 图表正常显示
# [ ] 可以导出结果
```

## 常见问题

### 问题1：打包后运行报错"找不到模块"

解决方法：在app.spec的hiddenimports中添加该模块

### 问题2：打包文件体积过大（>300MB）

解决方法：
1. 使用UPX压缩（upx=True）
2. 排除不必要的库（在excludes中添加）
3. 考虑使用--onedir模式而非--onefile

### 问题3：Numba JIT编译失败

解决方法：确保NUMBA相关环境变量正确设置

### 问题4：中文显示乱码

解决方法：确保所有文件使用UTF-8编码

## 优化建议

### 减小体积

1. 使用UPX压缩
```bash
# 下载UPX: https://github.com/upx/upx/releases
# 解压到某个目录，如 C:\UPX
# 在spec文件中设置 upx=True
```

2. 排除大型库
```python
# 在app.spec的excludes中添加
excludes=[
    'matplotlib.tests',
    'pytest',
    'IPython',
]
```

### 加快启动速度

1. 预编译Numba函数（需要修改代码）
2. 减少导入的库数量
3. 使用启动画面掩盖加载时间

## 分发建议

### 单文件exe（推荐展示用）

- 优点：便于分享，只有一个文件
- 缺点：体积较大（150-200MB），启动较慢
- 适用：展示、演示

### 目录模式（推荐日常使用）

- 优点：启动快，体积分散
- 缺点：需要分发整个文件夹
- 适用：团队协作、开发测试

## 完整打包流程

```bash
# 1. 清理旧的打包文件
Remove-Item -Recurse -Force build, dist

# 2. 打包
pyinstaller app.spec

# 3. 测试
dist\EconLab.exe

# 4. 如果成功，可以分发 dist\EconLab.exe
```

## 预期结果

- 文件名：EconLab.exe
- 体积：约150-200MB（压缩后）
- 启动时间：3-5秒
- 运行环境：Windows 10/11，无需Python环境

