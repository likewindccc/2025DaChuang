# Phase 4: MFG求解器开发计划 - 稀疏网格+Numba方法 (更新版)

**创建日期**: 2025-10-03  
**更新日期**: 2025-10-03  
**方法选型**: 稀疏网格 + Numba加速  
**目标模块**: `src/modules/mfg/`

---

## 📋 已确认的设计要素

### ✅ 用户已确认的选择

1. **稀疏网格精度级别**: Level 5 (约15,000个网格点)
2. **稀疏网格库**: Tasmanian (ORNL)
3. **时间维度**: 方案A (无限期稳态均衡模型)
4. **努力水平离散化**: 方案A (a ∈ [0, 1]，21个点)
5. **市场紧张度θ更新**: 内生均衡
6. **初始分布**: 基于300条真实数据的边际分布+Copula联合分布

---

## 🔍 关键发现：基于研究计划的修正

### 1. 状态变量范围（基于真实数据分析）

根据`cleaned_data.csv`的300条真实样本数据分析：

| 状态变量 | 符号 | 最小值 | 最大值 | 均值 | 定义 |
|---------|------|--------|--------|------|------|
| 每周工作小时数 | T | 15 | 70 | 42.24 | 每天期望工作时数 × 每周期望工作天数 |
| 工作能力评分 | S | 2 | 44 | 25.02 | 工作能力评分 |
| 数字素养评分 | D | 0 | 20 | 8.62 | 数字素养评分 |
| 每月期望收入 | W | 1400 | 8000 | 4520.77 | 每月期望收入(元) |

**⚠️ 重要修正**: 
- 之前错误地设定了T∈[0,168], S∈[0,100], D∈[0,100], W∈[2000,12000]
- **正确范围应该是**:
  - T ∈ [15, 70] (稀疏网格可以略微扩展为 [10, 80] 以留余地)
  - S ∈ [2, 44] (扩展为 [0, 50])
  - D ∈ [0, 20] (扩展为 [0, 25])
  - W ∈ [1400, 8000] (扩展为 [1000, 9000])

---

### 2. 状态转移方程（研究计划第4.3节）

根据研究计划第1633-1765行，状态转移方程为：

```python
# (1) 工作时间投入增加公式
T_{t+1} = T_t + γ_T * a_t * (T_max - T_t)

# (2) 期望工作待遇调整公式
W_{t+1} = max(W_min, W_t - γ_W * a_t)

# (3) 工作能力提升公式
S_{t+1} = S_t + γ_S * a_t * (1 - S_t)  # ⚠️ S在此处标准化到0-1

# (4) 数字素养提升公式
D_{t+1} = D_t + γ_D * a_t * (1 - D_t)  # ⚠️ D在此处标准化到0-1
```

**关键参数**:
- `T_max`: 个体所能提供的最大工作时间上限（研究计划未指定具体值，建议=80小时/周）
- `W_min`: 期望工资下限（保障最低生活需求，建议=1000元/月）
- `γ_T`, `γ_S`, `γ_D`, `γ_W`: 状态转移速率参数（**研究计划未给出具体值，需要校准**）

**⚠️ 需要您确认**:

**Q1. 状态转移参数的初值设定**

由于研究计划未给出γ参数的具体值，请您确认以下初值（后续可通过Module 5校准调整）：

```python
建议初值:
gamma_T = 0.1   # 工作时长增长率 (每次努力a=1可增长10%的剩余空间)
gamma_S = 0.05  # 技能增长率 (标准化尺度下)
gamma_D = 0.08  # 数字素养增长率 (标准化尺度下)
gamma_W = 100   # 工资期望下降速率 (元/月)

T_max = 80      # 最大工作时长(小时/周)
W_min = 1000    # 最低工资期望(元/月)
```

**您的确认**: _________________ (同意/修改)

---

**Q2. S和D的标准化问题**

研究计划中，S和D在状态转移公式中是标准化到[0,1]区间的：
```python
S_{t+1} = S_t + γ_S * a_t * (1 - S_t)  # S ∈ [0, 1]
```

但真实数据中：
- S原始范围: [2, 44] 分
- D原始范围: [0, 20] 分

**方案A**: 在稀疏网格中使用原始分数，状态转移时先标准化再更新
```python
# 标准化
S_normalized = S / 100  # 假设满分100
D_normalized = D / 100

# 状态转移（标准化尺度）
S_norm_next = S_norm + γ_S * a * (1 - S_norm)
D_norm_next = D_norm + γ_D * a * (1 - D_norm)

# 反标准化
S_next = S_norm_next * 100
D_next = D_norm_next * 100
```

**方案B**: 直接在稀疏网格中使用标准化后的[0,1]值
```python
# 稀疏网格状态空间：x = (T, S_norm, D_norm, W)
# S_norm ∈ [0, 1], D_norm ∈ [0, 1]

# 状态转移直接在[0,1]上操作
S_norm_next = S_norm + γ_S * a * (1 - S_norm)
D_norm_next = D_norm + γ_D * a * (1 - D_norm)
```

**推荐**: 方案B（简化实现，符合研究计划公式）

**您的选择**: _________________ (A/B)

---

### 3. 效用函数设计（研究计划第4.1.1节）

根据研究计划第800-1003行：

#### 失业者的瞬时效用

```python
u^U(x, a) = b(x) - (1/2) * κ * a^2
```

其中：
- `b(x)`: 失业状态时的即时收益（如家庭生产、政府补助、失业救济等）
- `κ`: 努力成本系数（κ > 0）
- `(1/2) * κ * a^2`: 努力成本项（边际成本递增）

**⚠️ 研究计划未指定b(x)的具体形式**

**Q3. 失业救济函数b(x)的设定**

**方案A**: 常数失业救济
```python
b(x) = b_0  # 例如：b_0 = 500 元/月（失业基本生活补助）
```

**方案B**: 与技能相关的失业救济
```python
b(x) = b_0 + b_1 * S  # 技能越高，可能有更高的转移性收入或家庭生产价值
```

**方案C**: 零失业救济（简化）
```python
b(x) = 0
```

**推荐**: 方案C（简化模型，突出努力成本）

**您的选择**: _________________ (A/B/C)

**如果选择A或B，请指定参数**:
- `b_0` = _______
- `b_1` = _______ (仅方案B需要)

---

**Q4. 努力成本系数κ**

研究计划未给出κ的具体值。

```python
建议初值: κ = 1.0

# 经济学解释:
# a=0.5时，努力成本 = 0.5 * 1.0 * 0.25 = 0.125
# a=1.0时，努力成本 = 0.5 * 1.0 * 1.0  = 0.5
```

**您的确认**: κ = _______ (默认1.0，可后续校准)

---

#### 就业者的瞬时效用

根据研究计划第960-1003行：

```python
V_t^E(x, σ_i) = ω(x_t, σ_i) + ρ * [μ(x_t, σ_i) * V_{t+1}^U(x_{t+1}, σ_i) + (1 - μ(x_t, σ_i)) * V_{t+1}^E(x_{t+1}, σ_i)]
```

其中：
- `ω(x_t, σ_i)`: 就业状态的瞬时效用
- `μ(x_t, σ_i)`: 外生离职率函数

**⚠️ 研究计划未明确指定ω(x)的形式**

**Q5. 就业瞬时效用ω(x)的设定**

**方案A**: 等于期望工资（简化）
```python
ω(x) = W  # 就业者获得工资收入
```

**方案B**: 工资 - 工作负效用
```python
ω(x) = W - α_T * T  # T越大，工作越累
```

**推荐**: 方案A（简化，突出工资收益）

**您的选择**: _________________ (A/B)

---

**Q6. 外生离职率函数μ(x, σ_i)**

研究计划第1489-1493行提到："个体特征水平较低的就业者更易受到冲击"

**方案A**: 常数离职率
```python
μ = μ_0  # 例如：μ_0 = 0.05 (每期5%的外生离职概率)
```

**方案B**: 状态依赖的离职率
```python
μ(x) = μ_0 + μ_S * (1 - S_norm) + μ_D * (1 - D_norm)
# S、D越低，离职率越高
```

**推荐**: 方案A（简化，研究计划未给出具体形式）

**您的选择**: _________________ (A/B)

**请指定参数**:
- `μ_0` = _______ (建议：0.05，即每期5%离职概率)

---

### 4. 控制变量σ的真实含义（研究计划第2064-2072行）

**⚠️ 重大修正**: 我之前对σ的理解是错误的！

根据研究计划第2064-2072行，控制变量σ是：

> "𝛿_σ 为个体固定特征（如年龄、学历、孩子数等）对匹配成功的影响程度。"

**σ 不是"劳动力与市场平均的差距"，而是个体的固定特征变量**！

**清单数据中的控制变量**（`cleaned_data.csv`）:
- 年龄
- 学历 (1-6)
- 孩子数量
- 累计工作年限
- 是否曾工作 (0/1)

**在MFG求解中σ的处理**:

由于σ是固定特征（不随努力a改变），在MFG求解中有两种处理方式：

**方案A**: 将σ作为额外的状态维度（但这会增加维度，从4D→更高维）

**方案B**: 在匹配函数λ中使用σ的典型值或期望值
```python
# 使用所有劳动力的σ均值
σ_mean = E[σ] = 从m^U分布计算得到的σ期望

# 或使用每个网格点对应的σ典型值
σ(x) = 根据x的特征推断的典型σ
```

**方案C**: 简化处理，将σ的影响吸收到截距项δ_0中
```python
# 假设σ对所有个体影响相同，简化为常数
λ(x, a, θ) = 1 / (1 + exp[-(δ_0' + δ_x'x + δ_a*a + δ_θ*ln(θ))])
# 其中 δ_0' = δ_0 + δ_σ'E[σ]
```

**推荐**: 方案C（简化，避免增加状态空间维度）

**Q7. 您对控制变量σ的处理方式选择**

**您的选择**: _________________ (A/B/C)

---

### 5. 收敛标准（研究计划第4.6节）

根据研究计划第2253-2325行，MFG收敛标准为：

```python
(1) 价值函数收敛: |V_{t+1} - V_t| < ε_u
(2) 努力水平收敛: |a*_{t+1}(x) - a*_t(x)| < ε_a
(3) 失业率收敛: |u_{t+1} - u_t| < ε_u
```

**⚠️ 研究计划未给出ε的具体值**

**Q8. 收敛容差的设定**

```python
建议值:
ε_u = 1e-4   # 价值函数容差
ε_a = 1e-4   # 努力水平容差
ε_u = 1e-3   # 失业率容差 (宏观变量，可以稍宽松)

max_iterations = 500  # 最大迭代次数
```

**您的确认**: _________________ (同意/修改)

如果修改，请指定：
- `ε_u` (价值函数) = _______
- `ε_a` (努力水平) = _______
- `ε_u` (失业率) = _______
- `max_iterations` = _______

---

### 6. 贴现因子ρ

研究计划第908行提到："𝝆：贴现因子，体现个体对未来收益的偏好"

**⚠️ 研究计划未给出ρ的具体值**

**Q9. 贴现因子ρ的设定**

```python
建议值: ρ = 0.95

# 经济学解释:
# ρ=0.95 表示下一期的1元收益相当于当期的0.95元
# 对应年贴现率约为 1/0.95 - 1 ≈ 5.3%（如果每期=1个月，年贴现率≈63%）
```

**您的确认**: ρ = _______ (建议范围：0.90-0.99)

---

### 7. 市场紧张度θ的初值和更新

根据您的确认："内生均衡"

**定义**（研究计划第1418-1437行）:
```
θ_t = V / U_t

其中:
- V: 职位数（外生或固定）
- U_t = ∫ m^U(x,t) dx （失业人数，内生）
```

**Q10. θ的初值和更新机制**

**方案A**: θ固定（θ-bar 均衡）
```python
θ = θ_bar = 1.0  # 固定职位-失业比
V_t = θ_bar * U_t  # 职位数随失业人数调整
```

**方案B**: V固定（职位数外生）
```python
V = V_0 = 1000  # 固定职位数
θ_t = V_0 / max(U_t, 1e-10)  # θ随失业人数变化
```

您之前说"内生均衡"，我理解为**方案A（θ固定）**，请确认：

**您的选择**: _________________ (A/B)

**如果选择A，请指定**: θ_bar = _______ (建议：1.0)  
**如果选择B，请指定**: V_0 = _______ (建议：1000)

---

## 📦 完整参数设定总结

**请您填写以下完整的参数设定表**，我将据此开始开发：

### 状态空间

| 参数 | 范围 | 您的确认 |
|------|------|----------|
| T (每周工作小时) | [10, 80] | ☑ / ☐ 修改为_______ |
| S (工作能力,标准化) | [0, 1] | ☑ / ☐ 修改为_______ |
| D (数字素养,标准化) | [0, 1] | ☑ / ☐ 修改为_______ |
| W (每月期望收入) | [1000, 9000] | ☑ / ☐ 修改为_______ |

### 状态转移参数

| 参数 | 建议值 | 您的确认 |
|------|--------|----------|
| γ_T | 0.1 | ☑ / ☐ 修改为_______ |
| γ_S | 0.05 | ☑ / ☐ 修改为_______ |
| γ_D | 0.08 | ☑ / ☐ 修改为_______ |
| γ_W | 100 | ☑ / ☐ 修改为_______ |
| T_max | 80 | ☑ / ☐ 修改为_______ |
| W_min | 1000 | ☑ / ☐ 修改为_______ |

### 效用函数参数

| 参数 | 建议值 | 您的确认 |
|------|--------|----------|
| κ (努力成本) | 1.0 | ☑ / ☐ 修改为_______ |
| b(x) (失业救济) | 方案C (b=0) | ☑ / ☐ 选择方案___, 参数_______ |
| ω(x) (就业效用) | 方案A (ω=W) | ☑ / ☐ 选择方案___ |
| μ (离职率) | 方案A (μ=0.05) | ☑ / ☐ 选择方案___, μ_0=_______ |
| ρ (贴现因子) | 0.95 | ☑ / ☐ 修改为_______ |

### 控制变量处理

| 参数 | 建议方案 | 您的确认 |
|------|----------|----------|
| σ处理方式 | 方案C (吸收到截距) | ☑ / ☐ 选择方案___ |
| S/D标准化 | 方案B (网格中使用[0,1]) | ☑ / ☐ 选择方案___ |

### 收敛标准

| 参数 | 建议值 | 您的确认 |
|------|--------|----------|
| ε_u (价值函数) | 1e-4 | ☑ / ☐ 修改为_______ |
| ε_a (努力水平) | 1e-4 | ☑ / ☐ 修改为_______ |
| ε_u (失业率) | 1e-3 | ☑ / ☐ 修改为_______ |
| max_iterations | 500 | ☑ / ☐ 修改为_______ |

### 市场紧张度

| 参数 | 建议方案 | 您的确认 |
|------|----------|----------|
| θ更新机制 | 方案A (θ固定=1.0) | ☑ / ☐ 选择方案___, θ_bar=_______ |

### 稀疏网格

| 参数 | 已确认值 |
|------|----------|
| 精度级别 | Level 5 ✅ |
| 库选择 | Tasmanian ✅ |
| 努力离散点数 | 21 ✅ |

---

## 🚀 下一步行动

**在您填写完上述参数设定表后**，我将：

1. ✅ 安装并测试Tasmanian库
2. ✅ 更新`config/default/mfg.yaml`配置文件
3. ✅ 开始实现8个核心文件：
   - `sparse_grid.py`
   - `state_space.py`
   - `bellman_solver.py`
   - `kfe_solver.py`
   - `mfg_simulator.py`
   - `utility_functions.py`
   - `state_transition.py`
   - `interpolation.py`

4. ✅ 编写完整的单元测试和集成测试
5. ✅ 验收：功能、性能、代码质量

---

## ⚠️ 重要提醒

**在您确认所有参数之前，我不会开始任何代码实现！**

请您仔细填写上述参数设定表，如有任何疑问，请随时提出，我会详细解答。

---

**文档版本**: v2.0 (基于研究计划修正)  
**创建日期**: 2025-10-03  
**状态**: ⏳ 等待用户填写参数设定表

